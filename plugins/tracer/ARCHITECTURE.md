# Tracer Plugin Architecture

The tracer has been refactored from a core utility (`src/core/tracer.hpp`) to a full-fledged plugin (`plugins/tracer/`).

## Architecture Overview

### Plugin Structure

```
plugins/tracer/
├── CMakeLists.txt              # Build configuration (header-only library)
├── README.md                   # Plugin documentation
├── src/
│   └── tracer_plugin.hpp       # Main plugin implementation
├── examples/
│   └── tracer_demo.cpp         # Usage demonstration
└── tests/
    └── test_tracer.cpp         # Test suite
```

### Design Principles

1. **Header-Only**: No compiled artifacts, easy integration
2. **Singleton Pattern**: Global instance accessible via `get_tracer()`
3. **Pluggable Levels**: Four verbosity levels for different use cases
4. **Namespace Isolation**: Lives in `forma::tracer` namespace
5. **No External Dependencies**: Only standard C++ library

## Key Components

### TraceLevel Enum

```cpp
enum class TraceLevel {
    Silent,   // No output except errors
    Normal,   // Stage markers only
    Verbose,  // Detailed statistics
    Debug     // Internal operations
};
```

### TracerPlugin Class

**Public Interface:**
- `set_level(TraceLevel)` - Configure verbosity
- `get_level()` - Query current level
- `begin_stage(string_view)` - Start a new stage
- `end_stage()` - Complete current stage
- `info(string_view)` - Normal information
- `verbose(string_view)` - Verbose details
- `debug(string_view)` - Debug information
- `error(string_view)` - Error messages (always shown)
- `warning(string_view)` - Warning messages
- `stat(key, value)` - Statistics (verbose+)
- `success(string_view)` - Success message
- `failure(string_view)` - Failure message (always shown)

**Features:**
- Automatic indentation for nested stages
- Visual markers (▶, ✓, ✗, ⚠)
- Conditional output based on verbosity level
- Stage tracking with current_stage state

### Global Access

```cpp
// Get singleton instance
auto& tracer = forma::tracer::get_tracer();

// Optional: set custom instance
forma::tracer::set_tracer(custom_tracer_ptr);
```

## Integration with Forma Compiler

The tracer plugin is integrated throughout the compilation pipeline:

### demos/main.cpp

1. **Include**: `#include "../plugins/tracer/src/tracer_plugin.hpp"`
2. **Initialize**: `auto& tracer = forma::tracer::get_tracer();`
3. **Configure**: Based on CLI flags (`-v`, `--debug`)
4. **Use**: Throughout all compilation stages

### Compilation Stages

```
▶ Reading source file
  [verbose: file path, size]
✓ Reading source file complete

▶ Parsing
  [verbose: type/enum/event/instance counts]
✓ Parsing complete

▶ Type checking
  [always: errors and warnings]
✓ Type checking complete

▶ Collecting assets
  [verbose: asset URIs]
✓ Collecting assets complete

▶ Code generation
  [verbose: renderer, output path]
  [debug: internal operations]
  [verbose: generated byte count]
✓ Code generation complete

✓ Compilation successful
  Output: path/to/output.c
```

## Migration from Core Tracer

### Changes Made

1. **Location**: `src/core/tracer.hpp` → `plugins/tracer/src/tracer_plugin.hpp`
2. **Namespace**: `forma::` → `forma::tracer::`
3. **Instance**: `forma::g_tracer` → `forma::tracer::get_tracer()`
4. **API**: Simplified `end_stage()` - no longer takes parameters

### Updated Code Patterns

**Before:**
```cpp
#include "../src/core/tracer.hpp"
forma::g_tracer.begin_stage("Parsing");
forma::g_tracer.end_stage("Parsing complete");
```

**After:**
```cpp
#include "../plugins/tracer/src/tracer_plugin.hpp"
auto& tracer = forma::tracer::get_tracer();
tracer.begin_stage("Parsing");
tracer.end_stage();  // Automatically uses stage name
```

## Usage Examples

### Basic Usage

```cpp
#include "plugins/tracer/src/tracer_plugin.hpp"

using namespace forma::tracer;

int main() {
    auto& tracer = get_tracer();
    tracer.set_level(TraceLevel::Verbose);
    
    tracer.begin_stage("Processing");
    tracer.info("Starting work");
    tracer.stat("Items", 100);
    tracer.end_stage();
    
    tracer.success("Complete!");
    return 0;
}
```

### Conditional Output

```cpp
// Always shown regardless of level
tracer.error("Fatal error occurred");
tracer.failure("Operation failed");

// Shown in Normal+ mode
tracer.info("Processing...");
tracer.warning("Potential issue");

// Shown in Verbose+ mode
tracer.verbose("Detailed information");
tracer.stat("Count", 42);

// Shown in Debug mode only
tracer.debug("Internal state dump");
```

### Nested Stages

```cpp
tracer.begin_stage("Outer");
tracer.info("Level 1");

    tracer.begin_stage("Inner");
    tracer.info("Level 2");
    tracer.end_stage();

tracer.info("Back to level 1");
tracer.end_stage();
```

Output:
```
▶ Outer
  Level 1
  ▶ Inner
    Level 2
  ✓ Inner complete
  Back to level 1
✓ Outer complete
```

## Benefits of Plugin Architecture

1. **Modularity**: Tracer is now a separate, reusable component
2. **Testability**: Dedicated test suite in `tests/`
3. **Documentation**: Self-contained docs in `README.md`
4. **Examples**: Demo programs in `examples/`
5. **Buildability**: Can be built/tested independently with CMake
6. **Reusability**: Other projects can use this plugin
7. **Maintainability**: Clear separation from core compiler logic

## Testing

```bash
# Build and run tests
g++ -std=c++20 plugins/tracer/tests/test_tracer.cpp -o test_tracer
./test_tracer

# Run demo
g++ -std=c++20 -I. plugins/tracer/examples/tracer_demo.cpp -o tracer_demo
./tracer_demo
```

## Future Enhancements

Potential improvements to the tracer plugin:

- [ ] Color output support (ANSI codes)
- [ ] Timestamp logging
- [ ] Log file output (in addition to stdout)
- [ ] Progress bars for long operations
- [ ] Structured JSON output mode
- [ ] Performance timing per stage
- [ ] Custom output streams
- [ ] Thread-safe logging
- [ ] Log filtering by category
- [ ] Integration with syslog/systemd journal

## Plugin Metadata

- **Name**: tracer
- **Version**: 0.1.0
- **Type**: Tooling/Diagnostics
- **Dependencies**: None (C++20 standard library only)
- **License**: Same as Forma core
